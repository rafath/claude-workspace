#!/bin/bash

### Pulls workspace updates from upstream remote.
# The "workspace" remote is configured by setup-workspace.
# Usage: dev/run/pull-workspace

set -e

WORKSPACE_FILE="dev/workspace/WORKSPACE.md"

# Step 1: Check workspace remote exists
if ! git remote get-url workspace >/dev/null 2>&1; then
    echo "âŒ 'workspace' remote not configured"
    echo "   Run: dev/run/setup-workspace"
    exit 1
fi

# Step 2: Parse parent_branch from WORKSPACE.md
PARENT_BRANCH=""
if [[ -f "$WORKSPACE_FILE" ]]; then
    PARENT_BRANCH=$(sed -n '/^---$/,/^---$/p' "$WORKSPACE_FILE" | grep "^parent_branch:" | cut -d: -f2 | tr -d ' ')
fi
PARENT_BRANCH="${PARENT_BRANCH:-main}"

# Step 3: Get current branch
CURRENT_BRANCH=$(git branch --show-current)

echo "ğŸ“¦ Pull workspace updates"
echo "   From:   workspace remote"
echo "   Into:   $PARENT_BRANCH"
echo ""

# Step 4: Check working tree is clean
if [[ -n $(git status --porcelain) ]]; then
    echo "âŒ Working tree is not clean"
    echo "   Commit or stash changes first"
    git status --short
    exit 1
fi
echo "âœ“ Working tree is clean"
echo ""

# Introduce a check gate.
read -p "Workspace ready. Pull into $PARENT_BRANCH? [y/N] " -n 1 -r
echo
[[ $REPLY =~ ^[Yy]$ ]] || { echo "Workspace pull aborted."; exit 0; }


# Step 5: Fetch from workspace remote
echo ""
echo "ğŸ”„ Fetching workspace remote..."
git fetch workspace

# Step 6: Checkout parent branch and pull
echo "ğŸ”„ Checking out $PARENT_BRANCH..."
git checkout "$PARENT_BRANCH"

echo "ğŸ”„ Pulling from workspace/main..."
# --allow-unrelated-histories needed when repo wasn't forked from workspace
git pull workspace main --no-edit --allow-unrelated-histories

echo "âœ“ Pulled workspace updates into $PARENT_BRANCH"

# Step 7: Return to original branch if different
if [[ "$CURRENT_BRANCH" != "$PARENT_BRANCH" ]]; then
    echo ""
    echo "ğŸ”„ Returning to $CURRENT_BRANCH..."
    git checkout "$CURRENT_BRANCH"

    echo ""
    echo "â„¹ To get updates in your feature branch:"
    echo "   git merge $PARENT_BRANCH"
fi

echo ""
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo "  âœ“ Workspace updated!"
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
