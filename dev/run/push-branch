#!/bin/bash

### Pushes current branch to remote with safety checks.
# Prevents pushing directly to parent branches.
# Reads remote from WORKSPACE.md.
# Usage: dev/run/push-branch


set -e

WORKSPACE_FILE="dev/workspace/WORKSPACE.md"

# Step 1: Parse config from WORKSPACE.md
REMOTE=""
PARENT_BRANCH=""
if [[ -f "$WORKSPACE_FILE" ]]; then
    REMOTE=$(sed -n '/^---$/,/^---$/p' "$WORKSPACE_FILE" | grep "^remote:" | cut -d: -f2 | tr -d ' ')
    PARENT_BRANCH=$(sed -n '/^---$/,/^---$/p' "$WORKSPACE_FILE" | grep "^parent_branch:" | cut -d: -f2 | tr -d ' ')
fi
REMOTE="${REMOTE:-origin}"
PARENT_BRANCH="${PARENT_BRANCH:-main}"

# Step 2: Get current branch
CURRENT_BRANCH=$(git branch --show-current)

# Step 3: Safety check - prevent pushing to protected branches
PROTECTED_BRANCHES="main master command $PARENT_BRANCH"
for branch in $PROTECTED_BRANCHES; do
    if [[ "$CURRENT_BRANCH" == "$branch" ]]; then
        echo "âŒ Cannot push directly to $CURRENT_BRANCH"
        echo "   Use merge-branch to merge feature branches into $PARENT_BRANCH"
        exit 1
    fi
done

echo "ğŸ“¤ Push branch"
echo "   Branch: $CURRENT_BRANCH"
echo "   Remote: $REMOTE"
echo ""

# Step 4: Check remote status and determine if force is needed
git fetch "$REMOTE" >/dev/null 2>&1

UPSTREAM="$REMOTE/$CURRENT_BRANCH"
FORCE_NEEDED=false
NEW_BRANCH=false

if git rev-parse --verify "$UPSTREAM" >/dev/null 2>&1; then
    AHEAD=$(git rev-list --count "$UPSTREAM"..HEAD)
    BEHIND=$(git rev-list --count HEAD.."$UPSTREAM")

    if [[ "$AHEAD" -eq 0 && "$BEHIND" -eq 0 ]]; then
        echo "âœ“ Already up to date with $REMOTE"
        exit 0
    fi

    if [[ "$BEHIND" -gt 0 ]]; then
        FORCE_NEEDED=true
        echo "   âš ï¸  History has diverged from remote"
        echo "   Local is $AHEAD ahead, $BEHIND behind $UPSTREAM"
        echo "   (likely due to rebase, amend, or reset)"
    else
        echo "   $AHEAD commit(s) to push"
    fi
else
    NEW_BRANCH=true
    echo "   New branch (will set upstream)"
fi

# Step 5: Handle force push confirmation if needed
FORCE_FLAG=""
if [[ "$FORCE_NEEDED" == true ]]; then
    echo ""
    read -p "Force push required. Overwrite remote and continue? [y/N] " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo "Push aborted."
        exit 0
    fi
    FORCE_FLAG="--force-with-lease"
fi

# Step 6: Confirmation gate
echo ""
read -p "Push to $REMOTE/$CURRENT_BRANCH? [y/N] " -n 1 -r
echo
if [[ ! $REPLY =~ ^[Yy]$ ]]; then
    echo "Push aborted."
    exit 0
fi

# Step 7: Push
echo ""
echo "ğŸ”„ Pushing to $REMOTE..."
if [[ -n "$FORCE_FLAG" ]]; then
    git push $FORCE_FLAG "$REMOTE" "$CURRENT_BRANCH"
else
    git push -u "$REMOTE" "$CURRENT_BRANCH"
fi

echo ""
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo "  âœ“ Pushed to $REMOTE/$CURRENT_BRANCH"
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
