#!/bin/bash

### Resets local main to match origin/main exactly (pristine copy).
# Safety: Must be on clean main branch. Blocks if unpushed commits exist.
# Usage: dev/run/pull-to-pristine-main [--ignore]
#   --ignore  Bypass unpushed commits check (commits will be lost)

set -e

#IGNORE_FLAG=false
#if [[ "$1" == "--ignore" ]]; then
#    IGNORE_FLAG=true
#fi

# Step 1: Must be on main branch
CURRENT_BRANCH=$(git branch --show-current)
if [[ "$CURRENT_BRANCH" != "main" ]]; then
    echo "‚ùå Must be on main branch"
    echo "   Current branch: $CURRENT_BRANCH"
    echo "   Run: git checkout main"
    exit 1
fi

# Step 2: Working tree must be clean
if [[ -n $(git status --porcelain) ]]; then
    echo "‚ùå Working tree is not clean"
    echo "   Commit or stash changes before running this script"
    echo ""
    git status --short
    exit 1
fi

# Step 3: Fetch origin and verify origin/main exists
echo "üì° Fetching origin..."
git fetch origin

if ! git rev-parse --verify origin/main >/dev/null 2>&1; then
    echo "‚ùå origin/main does not exist"
    echo "   Check your remote configuration: git remote -v"
    exit 1
fi

# Step 4: Check for unpushed commits
UNPUSHED=$(git log origin/main..main --oneline)
if [[ -n "$UNPUSHED" ]]; then
    echo "‚ö†Ô∏è  Local main is ahead of origin. These commits will be lost:"
    echo "   ${UNPUSHED//$'\n'/$'\n'   }"
    echo ""

    # Introduce a check gate.
    read -p "Do you want to continue and lose commits? [y/N] " -n 1 -r
    echo
    [[ $REPLY =~ ^[Yy]$ ]] || { echo "‚ùå Reset aborted by user: local main is ahead of origin"; exit 0; }

#    if [[ "$IGNORE_FLAG" == false ]]; then
#        echo "‚ùå Reset aborted: local main is ahead of origin"
#        echo "   To proceed, run again with: --ignore"
#        exit 1
#    else
#        echo "‚ö†Ô∏è  --ignore flag set, proceeding anyway..."
#    fi
fi

# Step 5: Reset to origin/main
echo "üîÑ Resetting main to origin/main..."
git reset --hard origin/main

echo ""
echo "‚úì Local main is now pristine copy of origin/main"
git log -1 --oneline
