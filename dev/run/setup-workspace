#!/bin/bash

### Initialise workspace merge drivers and remote branches.

# This config file only needs to be run once to initialise workspace settings.

# Merge driver (idempotent). Use the `protect` driver in .gitattributes on dev/workspace
# to prevent a feature branch from overwriting the parent branch with new files or changes.
echo ""

git config merge.protect.name "Protect from merging"
git config merge.protect.driver true
echo "Workspace merge protection initialised."

# Locally ignore these locations in Git.
mkdir -p .git/info && touch .git/info/exclude
for p in "/dev/workspace/context/tree.md" "/dev/project/" "/dev/run/" "/.claude/*" "!/.claude/config/" "!/.claude/rules/"; do
grep -qxF "$p" .git/info/exclude || echo "$p" >> .git/info/exclude
done
echo "Local files ignored by Git"

# Add these attributes to .gitattributes
touch .gitattributes
for p in "dev/workspace/** merge=protect" ".claude/config/** merge=protect" "README.md merge=protect"; do
    grep -qxF "$p" .gitattributes || echo "$p" >>.gitattributes
done
echo "Merge strategies set"

# Exclude dev workspace from Docker builds (if .dockerignore exists)
if [ -f .dockerignore ]; then
    grep -qxF "/dev/" .dockerignore || echo "/dev/" >> .dockerignore
    echo "Dev workspace excluded from Docker builds"
else
    echo "No .dockerignore found (skipped)"
fi

# Remote workspace repository (add or update). Pull workspace updates from the `workspace` origin.
git remote add workspace https://github.com/dilberryhoundog/dev-workspace.git 2>/dev/null || git remote set-url workspace https://github.com/dilberryhoundog/dev-workspace.git
echo "Workspace remote repository added"

chmod +x dev/run/*
echo "Workspace scripts registered"
echo ""

echo "Setup complete."
