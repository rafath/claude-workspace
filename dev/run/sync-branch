#!/bin/bash

### Pulls latest parent branch into current feature branch.
# Reads parent_branch and remote from WORKSPACE.md.
# Usage: dev/run/sync-branch [--rebase]
#   --rebase  Rebase onto parent instead of merge

set -e

WORKSPACE_FILE="dev/workspace/WORKSPACE.md"

# Step 1: Parse config from WORKSPACE.md
REMOTE=""
PARENT_BRANCH=""
if [[ -f "$WORKSPACE_FILE" ]]; then
    REMOTE=$(sed -n '/^---$/,/^---$/p' "$WORKSPACE_FILE" | grep "^remote:" | cut -d: -f2 | tr -d ' ')
    PARENT_BRANCH=$(sed -n '/^---$/,/^---$/p' "$WORKSPACE_FILE" | grep "^parent_branch:" | cut -d: -f2 | tr -d ' ')
fi
REMOTE="${REMOTE:-origin}"
PARENT_BRANCH="${PARENT_BRANCH:-main}"

# Step 2: Get current branch and validate
CURRENT_BRANCH=$(git branch --show-current)
if [[ "$CURRENT_BRANCH" == "main" || "$CURRENT_BRANCH" == "master" || "$CURRENT_BRANCH" == "command" ]]; then
    echo "âŒ Already on $CURRENT_BRANCH - nothing to sync"
    exit 1
fi

# Step 3: Parse args
USE_REBASE=false
if [[ "$1" == "--rebase" ]]; then
    USE_REBASE=true
fi

echo "ğŸ”„ Sync branch"
echo "   Branch: $CURRENT_BRANCH"
echo "   From:   $REMOTE/$PARENT_BRANCH"
echo "   Method: $([ "$USE_REBASE" == true ] && echo "rebase" || echo "merge")"
echo ""

# Step 4: Check working tree is clean
if [[ -n $(git status --porcelain) ]]; then
    echo "âŒ Working tree is not clean"
    echo "   Commit or stash changes first"
    git status --short
    exit 1
fi
echo "âœ“ Working tree is clean"

# Step 5: Fetch latest
echo ""
echo "ğŸ”„ Fetching $REMOTE/$PARENT_BRANCH..."
git fetch "$REMOTE" "$PARENT_BRANCH"

# Step 6: Check if already up to date
BEHIND=$(git rev-list --count HEAD.."$REMOTE/$PARENT_BRANCH")
if [[ "$BEHIND" -eq 0 ]]; then
    echo ""
    echo "âœ“ Already up to date with $PARENT_BRANCH"
    exit 0
fi

echo "   $BEHIND commit(s) to pull"

# Step 7: Sync
echo ""
if [[ "$USE_REBASE" == true ]]; then
    # Introduce a check gate.
    read -p "Branch ready. Rebase onto $REMOTE/$PARENT_BRANCH? [y/N] " -n 1 -r
    echo
    [[ $REPLY =~ ^[Yy]$ ]] || { echo "Rebase aborted."; exit 0; }

    echo "ğŸ”„ Rebasing onto $REMOTE/$PARENT_BRANCH..."
    git rebase "$REMOTE/$PARENT_BRANCH"
else
    # Introduce a check gate.
    read -p "Branch ready. Merge from $REMOTE/$PARENT_BRANCH? [y/N] " -n 1 -r
    echo
    [[ $REPLY =~ ^[Yy]$ ]] || { echo "Merge aborted."; exit 0; }

    echo "ğŸ”„ Merging $REMOTE/$PARENT_BRANCH..."
    git merge "$REMOTE/$PARENT_BRANCH" --no-edit
fi

echo ""
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo "  âœ“ Branch synced with $PARENT_BRANCH"
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
