#!/bin/bash

### Summarize, rename and sanitize a transcript file via headless Claude.
# Usage from project root: ./dev/run/process-conversation <path-to-transcript.txt>
#
# Called by: extract_transcript.rb hook (session_end)
# Or run manually to retry failed renames.

set -e

file="$1"

if [[ -z "$file" ]]; then
  echo "Usage: $0 <transcript-file>"
  exit 1
fi

if [[ ! -f "$file" ]]; then
  echo "Error: File not found: $file"
  exit 1
fi

# Sanitize user paths
script_dir="$(dirname "$0")"
"$script_dir/sanitize-paths" "$file"

# Summarize and rename with headless Claude
claude -p "Read $file, analyze the conversation, edit the SUMMARY section with a descriptive summary of the conversation (max 5 lines, place between the >>> <<< signals ), create a concise descriptive title (max 6 words, kebab-case), then rename the file to <yy-mm-dd>_<title>.txt" \
  --allowedTools "Read,Edit,Bash" \
  --model haiku
