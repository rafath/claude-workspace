#!/bin/bash

### Merges current branch to parent (per WORKSPACE.md).
# Reads remote, parent_branch, and merge strategy from dev/workspace/WORKSPACE.md
# Usage: dev/run/merge-branch [--squash|--rebase]
#   --squash  Override: squash merge
#   --rebase  Override: rebase merge
#   (default) Uses strategy from WORKSPACE.md, or full history merge

set -e

WORKSPACE_FILE="dev/workspace/WORKSPACE.md"

# Step 1: Check WORKSPACE.md exists
if [[ ! -f "$WORKSPACE_FILE" ]]; then
    echo "âŒ WORKSPACE.md not found at $WORKSPACE_FILE"
    exit 1
fi

# Step 2: Parse front matter
REMOTE=$(sed -n '/^---$/,/^---$/p' "$WORKSPACE_FILE" | grep "^remote:" | cut -d: -f2 | tr -d ' ')
PARENT_BRANCH=$(sed -n '/^---$/,/^---$/p' "$WORKSPACE_FILE" | grep "^parent_branch:" | cut -d: -f2 | tr -d ' ')

# Defaults if not specified
REMOTE="${REMOTE:-origin}"
PARENT_BRANCH="${PARENT_BRANCH:-main}"

# Step 3: Parse merge strategy from checkboxes (can be overridden by args)
MERGE_FLAG=""
STRATEGY_NAME="merge"

if grep -q "\- \[x\] Squash merge" "$WORKSPACE_FILE"; then
    MERGE_FLAG="--squash"
    STRATEGY_NAME="squash merge"
elif grep -q "\- \[x\] Rebase merge" "$WORKSPACE_FILE"; then
    MERGE_FLAG="--rebase"
    STRATEGY_NAME="rebase merge"
fi

# Allow command line override
if [[ "$1" == "--squash" ]]; then
    MERGE_FLAG="--squash"
    STRATEGY_NAME="squash merge"
elif [[ "$1" == "--rebase" ]]; then
    MERGE_FLAG="--rebase"
    STRATEGY_NAME="rebase merge"
fi

# Step 4: Get current branch and validate
CURRENT_BRANCH=$(git branch --show-current)
if [[ "$CURRENT_BRANCH" == "main" || "$CURRENT_BRANCH" == "master" || "$CURRENT_BRANCH" == "command" ]]; then
    echo "âŒ Cannot merge from $CURRENT_BRANCH branch"
    exit 1
fi

echo "ðŸ“‹ Merge branch"
echo "   Branch:   $CURRENT_BRANCH"
echo "   Target:   $PARENT_BRANCH"
echo "   Remote:   $REMOTE"
echo "   Strategy: $STRATEGY_NAME"
echo ""

# Step 5: Check working tree is clean
if [[ -n $(git status --porcelain) ]]; then
    echo "âŒ Working tree is not clean"
    git status --short
    exit 1
fi
echo "âœ“ Working tree is clean"

# Step 6: Check for PR
PR_NUMBER=$(gh pr view --json number -q '.number' 2>/dev/null)
if [[ -z "$PR_NUMBER" ]]; then
    echo "âŒ No PR exists for this branch"
    echo "   Create one with: gh pr create"
    exit 1
fi
echo "âœ“ PR #$PR_NUMBER exists"

# Step 7: Fetch and check for merge conflicts
echo ""
echo "ðŸ”„ Fetching $REMOTE..."
git fetch "$REMOTE" "$PARENT_BRANCH" >/dev/null 2>&1

MERGE_BASE=$(git merge-base HEAD "$REMOTE/$PARENT_BRANCH" 2>/dev/null)
if [[ -n "$MERGE_BASE" ]]; then
    CONFLICTS=$(git merge-tree "$MERGE_BASE" HEAD "$REMOTE/$PARENT_BRANCH" 2>/dev/null | grep -c "^<<<<<<<" || true)
    if [[ "$CONFLICTS" -gt 0 ]]; then
        echo "âŒ Merge conflicts detected with $PARENT_BRANCH"
        echo "   Resolve with: git merge $REMOTE/$PARENT_BRANCH"
        exit 1
    fi
fi
echo "âœ“ No merge conflicts"
echo ""

# Introduce a check gate.
read -p "Branch ready. Push to $REMOTE and $STRATEGY_NAME? [y/N] " -n 1 -r
echo
[[ $REPLY =~ ^[Yy]$ ]] || { echo "Merge aborted."; exit 0; }


# Step 8: Push to remote
echo ""
echo "ðŸ”„ Pushing to $REMOTE..."
git push "$REMOTE" "$CURRENT_BRANCH"
echo "âœ“ Pushed to $REMOTE/$CURRENT_BRANCH"

# Step 9: Merge to parent branch
echo ""
echo "ðŸ”„ Merging to $PARENT_BRANCH..."

if [[ "$MERGE_FLAG" == "--rebase" ]]; then
    # Rebase: replay commits onto parent, then fast-forward
    git pull "$REMOTE" "$PARENT_BRANCH" --rebase=false
    git rebase "$REMOTE/$PARENT_BRANCH"
    git checkout "$PARENT_BRANCH"
    git merge --ff-only "$CURRENT_BRANCH"
else
    git checkout "$PARENT_BRANCH"
    git pull "$REMOTE" "$PARENT_BRANCH"

    if [[ "$MERGE_FLAG" == "--squash" ]]; then
        git merge --squash "$CURRENT_BRANCH"
        git commit -m "ðŸ”€ merge: $CURRENT_BRANCH (squash)"
    else
        git merge "$CURRENT_BRANCH" -m "ðŸ”€ merge: $CURRENT_BRANCH"
    fi
fi

echo "âœ“ Merged $CURRENT_BRANCH to $PARENT_BRANCH"

# Step 10: Push parent branch
echo ""
echo "ðŸ”„ Pushing $PARENT_BRANCH..."
git push "$REMOTE" "$PARENT_BRANCH"
echo "âœ“ Pushed $PARENT_BRANCH to $REMOTE"

echo ""
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo "  âœ“ Merge complete!"
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""
echo "PR #$PR_NUMBER can now be closed"
echo "To delete the branch: git branch -d $CURRENT_BRANCH"
