#!/bin/bash

### Reports merge readiness status without making changes.
# Checks: branch, working tree, commits, conflicts, PR, WORKSPACE.md config.
# Usage: dev/run/merge-preflight

WORKSPACE_FILE="dev/workspace/WORKSPACE.md"
WARNINGS=""
PASSED=""

add_warning() {
    WARNINGS="${WARNINGS}⚠️  $1\n"
}

add_passed() {
    PASSED="${PASSED}✓ $1\n"
}

# Step 1: Check not on main/master branch
CURRENT_BRANCH=$(git branch --show-current)
if [[ "$CURRENT_BRANCH" == "main" || "$CURRENT_BRANCH" == "master" || "$CURRENT_BRANCH" == "command" ]]; then
    echo "❌ Cannot run preflight from $CURRENT_BRANCH branch"
    exit 1
fi
add_passed "On feature branch: $CURRENT_BRANCH"

# Parse front matter from WORKSPACE.md for remote and parent_branch
if [[ -f "$WORKSPACE_FILE" ]]; then
    REMOTE=$(sed -n '/^---$/,/^---$/p' "$WORKSPACE_FILE" | grep "^remote:" | cut -d: -f2 | tr -d ' ')
    PARENT_BRANCH=$(sed -n '/^---$/,/^---$/p' "$WORKSPACE_FILE" | grep "^parent_branch:" | cut -d: -f2 | tr -d ' ')
fi

# Defaults if not specified
REMOTE="${REMOTE:-origin}"
PARENT_BRANCH="${PARENT_BRANCH:-main}"

# Step 2: Check working tree is clean
if [[ -n $(git status --porcelain) ]]; then
    add_warning "Working tree is not clean"
else
    add_passed "Working tree is clean"
fi

# Step 3: Fetch and check commits pushed
git fetch "$REMOTE" >/dev/null 2>&1

UPSTREAM="$REMOTE/$CURRENT_BRANCH"
if git rev-parse --verify "$UPSTREAM" >/dev/null 2>&1; then
    UNPUSHED=$(git log "$UPSTREAM..$CURRENT_BRANCH" --oneline)
    if [[ -n "$UNPUSHED" ]]; then
        add_warning "Unpushed commits exist"
    else
        add_passed "All commits pushed"
    fi
else
    add_warning "No upstream branch (not pushed yet)"
fi

# Step 4: Check for merge conflicts with parent branch
git fetch "$REMOTE" "$PARENT_BRANCH" >/dev/null 2>&1
MERGE_BASE=$(git merge-base HEAD "$REMOTE/$PARENT_BRANCH" 2>/dev/null)
if [[ -n "$MERGE_BASE" ]]; then
    CONFLICTS=$(git merge-tree "$MERGE_BASE" HEAD "$REMOTE/$PARENT_BRANCH" 2>/dev/null | grep -c "^<<<<<<<" || true)
    if [[ "$CONFLICTS" -gt 0 ]]; then
        add_warning "Potential merge conflicts with $PARENT_BRANCH"
    else
        add_passed "No merge conflicts with $PARENT_BRANCH"
    fi
else
    add_warning "Could not determine merge base with $PARENT_BRANCH"
fi

# Step 5: Check for PR
PR_JSON=$(gh pr view --json number,state,title,isDraft 2>/dev/null)
if [[ -n "$PR_JSON" ]]; then
    PR_NUMBER=$(echo "$PR_JSON" | grep -o '"number":[0-9]*' | cut -d: -f2)
    PR_DRAFT=$(echo "$PR_JSON" | grep -o '"isDraft":true' || true)
    if [[ -n "$PR_DRAFT" ]]; then
        add_warning "PR #$PR_NUMBER is in draft state"
    else
        add_passed "PR #$PR_NUMBER exists"
    fi
else
    add_warning "No PR exists for this branch"
fi

# Step 6: Parse WORKSPACE.md
MERGE_STRATEGY=""
ARCHIVE_WORKSPACE=false

if [[ -f "$WORKSPACE_FILE" ]]; then
    add_passed "WORKSPACE.md found"

    # Parse merge strategy
    if grep -q "\- \[x\] Squash merge" "$WORKSPACE_FILE"; then
        MERGE_STRATEGY="squash"
    fi
    if grep -q "\- \[x\] Rebase merge" "$WORKSPACE_FILE"; then
        if [[ -n "$MERGE_STRATEGY" ]]; then
            add_warning "Multiple merge strategies selected"
            MERGE_STRATEGY="conflict"
        else
            MERGE_STRATEGY="rebase"
        fi
    fi
    if [[ -z "$MERGE_STRATEGY" ]]; then
        MERGE_STRATEGY="merge (default)"
    fi

    # Parse archive checkbox
    if grep -q "\- \[x\] Archive workspace upon merge" "$WORKSPACE_FILE"; then
        ARCHIVE_WORKSPACE=true
    fi
else
    add_warning "WORKSPACE.md not found at $WORKSPACE_FILE"
fi

# Step 7: Check archive exists if required
if [[ "$ARCHIVE_WORKSPACE" == true ]]; then
    ARCHIVE_BASE="dev/branches"

    # Parse branch to get archive name (matches archive-workspace naming)
    if [[ "$CURRENT_BRANCH" =~ ^(([^/]+)/)?(.+)$ ]]; then
        BRANCH_TYPE="${BASH_REMATCH[2]}"
        BRANCH_DESC="${BASH_REMATCH[3]}"

        if [[ -n "$BRANCH_TYPE" ]]; then
            ARCHIVE_NAME="${BRANCH_TYPE}_${BRANCH_DESC}"
        else
            ARCHIVE_NAME="${BRANCH_DESC}"
        fi

        ARCHIVE_PATH="${ARCHIVE_BASE}/${ARCHIVE_NAME}"

        if [[ -d "$ARCHIVE_PATH" ]]; then
            # macOS only: stat -f for format, -t for time format
            LAST_MODIFIED=$(stat -f "%Sm" -t "%Y-%m-%d %H:%M" "$ARCHIVE_PATH")
            add_passed "Workspace archived (last updated: $LAST_MODIFIED)"
        else
            add_warning "Archive required but none found (run: dev/run/archive-workspace)"
        fi
    fi
fi

# Output report
echo ""
echo "═══════════════════════════════════════"
echo "  MERGE PREFLIGHT REPORT"
echo "═══════════════════════════════════════"
echo ""
echo "Branch:   $CURRENT_BRANCH"
echo "Target:   $PARENT_BRANCH"
echo "Remote:   $REMOTE"
echo "Strategy: $MERGE_STRATEGY"
echo "Archive:  $ARCHIVE_WORKSPACE"
echo ""

if [[ -n "$PASSED" ]]; then
    echo "── Passed ──────────────────────────────"
    echo -e "$PASSED"
fi

if [[ -n "$WARNINGS" ]]; then
    echo "── Warnings ────────────────────────────"
    echo -e "$WARNINGS"
fi

# Summary
WARNING_COUNT=$(echo -e "$WARNINGS" | grep -c "⚠️" || true)
if [[ "$WARNING_COUNT" -gt 0 ]]; then
    echo "═══════════════════════════════════════"
    echo "  $WARNING_COUNT warning(s) - review before merge"
    echo "═══════════════════════════════════════"
else
    echo "═══════════════════════════════════════"
    echo "  ✓ Ready to merge"
    echo "═══════════════════════════════════════"
fi
